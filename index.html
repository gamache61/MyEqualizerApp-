<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no">
    <title>MyEqApp Ultimate AI</title>
    
    <link rel="manifest" href="manifest.json">
    <meta name="theme-color" content="#121212">
    <link rel="apple-touch-icon" href="icon-192.png">

    <style>
        body {
            font-family: 'Segoe UI', sans-serif;
            background-color: #121212;
            color: white;
            margin: 0;
            display: flex;
            justify-content: center;
            align-items: flex-start; 
            min-height: 100vh;
            overflow-y: auto; 
        }

        .player-container {
            width: 100%;
            max-width: 400px;
            background: #1e1e1e;
            padding: 20px;
            border-radius: 20px;
            text-align: center;
            margin-top: 20px;
            margin-bottom: 50px;
            box-shadow: 0 10px 30px rgba(0,0,0,0.5);
        }

        .header-row {
            display: flex;
            justify-content: center;
            align-items: center;
            margin-bottom: 10px;
            position: relative;
        }

        h1 { margin: 0; font-size: 22px; color: #bb86fc; }

        .status-light {
            width: 15px;
            height: 15px;
            border-radius: 50%;
            background-color: #ff0000; 
            box-shadow: 0 0 10px #ff0000;
            position: absolute;
            right: 5px;
            transition: 0.3s;
        }

        .status-light.green {
            background-color: #00ff00; 
            box-shadow: 0 0 15px #00ff00;
        }

        #startBtn {
            background-color: #bb86fc;
            color: black;
            font-weight: bold;
            font-size: 16px;
            padding: 20px;
            width: 100%;
            border: none;
            border-radius: 10px;
            cursor: pointer;
        }

        .hidden { display: none !important; }

        /* AI COMMAND BAR */
        .ai-box {
            display: flex;
            background: #2a2a2a;
            border-radius: 12px;
            padding: 5px 10px;
            margin-bottom: 20px;
            border: 1px solid #444;
        }
        #aiSearch {
            flex-grow: 1;
            background: transparent;
            border: none;
            color: white;
            padding: 10px;
            outline: none;
        }
        .ai-btn {
            background: none;
            border: none;
            font-size: 18px;
            cursor: pointer;
            filter: drop-shadow(0 0 5px #bb86fc);
        }

        #masterPlayBtn {
            width: 80px;
            height: 80px;
            border-radius: 50%;
            background: #2a2a2a;
            border: 4px solid #555;
            color: white;
            font-size: 35px;
            cursor: pointer;
            margin: 15px auto;
            display: flex;
            justify-content: center;
            align-items: center;
            transition: 0.2s;
        }
        
        #masterPlayBtn.playing {
            background: #bb86fc;
            color: #000;
            border-color: #bb86fc;
            box-shadow: 0 0 20px rgba(187, 134, 252, 0.4);
        }

        .file-controls { display: flex; justify-content: center; gap: 10px; margin: 15px 0; }
        .custom-file-upload { border: 2px solid #03dac6; padding: 10px 15px; cursor: pointer; border-radius: 50px; color: #03dac6; font-size: 13px; font-weight: bold;}
        input[type="file"] { display: none; }
        #saveBtn { background: #333; color: #aaa; border: 2px solid #555; padding: 10px 15px; border-radius: 50px; cursor: pointer; font-weight: bold; }

        .library-row { display: flex; gap: 5px; margin-bottom: 15px; }
        #librarySelect { flex-grow: 1; padding: 10px; border-radius: 10px; background: #2a2a2a; color: white; border: 1px solid #444; }
        #deleteBtn { background: #cf6679; border: none; border-radius: 10px; cursor: pointer; width: 45px; }

        .eq-grid { display: flex; justify-content: space-between; height: 160px; margin: 20px 0; }
        .eq-band { display: flex; flex-direction: column; align-items: center; width: 18%; }
        input[type=range].vertical { -webkit-appearance: none; width: 110px; transform: rotate(-90deg); margin: 55px 0; background: #444; height: 3px; border-radius: 5px;}
        input[type=range]::-webkit-slider-thumb { -webkit-appearance: none; height: 18px; width: 18px; border-radius: 50%; background: #bb86fc; cursor: pointer; }
        .band-label { font-size: 10px; color: #888; }

        audio { width: 100%; filter: invert(1); opacity: 0.5; height: 30px; margin-top: 10px;}
    </style>
</head>
<body>

    <div class="player-container">
        <div class="header-row">
            <h1>üéöÔ∏è MyEqApp AI</h1>
            <div id="statusLight" class="status-light"></div>
        </div>

        <button id="startBtn" onclick="initAudioEngine()">üëâ ACTIVATE ENGINE</button>

        <div id="controlsArea" class="hidden">
            <div class="ai-box">
                <input type="text" id="aiSearch" placeholder="Ask AI (e.g. 'Play something random')">
                <button class="ai-btn" onclick="aiSelectSong()">ü™Ñ</button>
            </div>

            <div class="file-controls">
                <label for="audioFile" class="custom-file-upload">üìÇ New File</label>
                <input type="file" id="audioFile">
                <button id="saveBtn" onclick="saveSong()">üíæ Save</button>
            </div>

            <div class="library-row">
                <select id="librarySelect" onchange="loadFromLibrary()">
                    <option value="">üìÇ Saved Library...</option>
                </select>
                <button id="deleteBtn" onclick="deleteSong()">üóëÔ∏è</button>
            </div>

            <div id="songTitle" style="font-size: 13px; color: #bb86fc; margin-bottom: 10px;">No song loaded</div>

            <button id="masterPlayBtn" onclick="forcePlay()">‚ñ∂</button>

            <div class="eq-grid">
                <div class="eq-band"><input type="range" class="vertical" id="eq60" min="-15" max="15" value="0"><span class="band-label">SUB</span></div>
                <div class="eq-band"><input type="range" class="vertical" id="eq250" min="-15" max="15" value="0"><span class="band-label">LOW</span></div>
                <div class="eq-band"><input type="range" class="vertical" id="eq1000" min="-15" max="15" value="0"><span class="band-label">MID</span></div>
                <div class="eq-band"><input type="range" class="vertical" id="eq4000" min="-15" max="15" value="0"><span class="band-label">HIGH</span></div>
                <div class="eq-band"><input type="range" class="vertical" id="eq12000" min="-15" max="15" value="0"><span class="band-label">AIR</span></div>
            </div>

            <audio id="audioPlayer" controls></audio>
        </div>
    </div>

    <script>
        // --- 1. PWA REGISTRATION ---
        if ('serviceWorker' in navigator) {
            window.addEventListener('load', () => {
                navigator.serviceWorker.register('./sw.js').catch(err => console.log(err));
            });
        }

        const audioPlayer = document.getElementById('audioPlayer');
        const startBtn = document.getElementById('startBtn');
        const controlsArea = document.getElementById('controlsArea');
        const masterPlayBtn = document.getElementById('masterPlayBtn');
        const librarySelect = document.getElementById('librarySelect');
        const saveBtn = document.getElementById('saveBtn');
        const statusLight = document.getElementById('statusLight');
        const eqIds = ['eq60', 'eq250', 'eq1000', 'eq4000', 'eq12000'];
        
        let audioContext, source, db;
        let filters = [];
        const frequencies = [60, 250, 1000, 4000, 12000];
        let currentFileBlob = null;
        let currentFileName = "";

        // --- 2. EQ SAVING LOGIC ---
        function saveEqSettings() {
            const settings = {};
            eqIds.forEach(id => settings[id] = document.getElementById(id).value);
            localStorage.setItem('myEqSettings', JSON.stringify(settings));
        }

        function loadEqSettings() {
            const saved = JSON.parse(localStorage.getItem('myEqSettings'));
            if (saved) eqIds.forEach(id => { if(saved[id]) document.getElementById(id).value = saved[id]; });
        }

        // --- 3. AI LOGIC ---
        function aiSelectSong() {
            const query = document.getElementById('aiSearch').value.toLowerCase();
            const store = db.transaction("songs").objectStore("songs");
            const req = store.getAll();

            req.onsuccess = (e) => {
                const songs = e.target.result;
                if (songs.length === 0) return alert("Library empty.");

                let match = null;
                if (query.includes("random") || query === "") {
                    match = songs[Math.floor(Math.random() * songs.length)];
                } else {
                    match = songs.find(s => s.name.toLowerCase().includes(query));
                }

                if (match) {
                    loadBlob(match.data, match.name);
                    librarySelect.value = match.id;
                    setTimeout(() => forcePlay(), 400);
                } else {
                    alert("AI: 'No match found in library.'");
                }
            };
        }

        // --- 4. ENGINE & DB ---
        function initAudioEngine() {
            try {
                loadEqSettings();
                audioContext = new (window.AudioContext || window.webkitAudioContext)();
                source = audioContext.createMediaElementSource(audioPlayer);

                filters = frequencies.map((freq, i) => {
                    const f = audioContext.createBiquadFilter();
                    f.type = i === 0 ? 'lowshelf' : i === 4 ? 'highshelf' : 'peaking';
                    f.frequency.value = freq;
                    f.gain.value = document.getElementById(eqIds[i]).value;
                    return f;
                });

                let node = source;
                filters.forEach(f => { node.connect(f); node = f; });
                node.connect(audioContext.destination);

                startBtn.classList.add('hidden');
                controlsArea.classList.remove('hidden');
                setupDB();
            } catch (e) { alert(e); }
        }

        function setupDB() {
            const request = indexedDB.open("MyEqLib", 1);
            request.onupgradeneeded = e => e.target.result.createObjectStore("songs", { keyPath: "id" });
            request.onsuccess = e => { db = e.target.result; refreshLibrary(); };
        }

        function saveSong() {
            if(!currentFileBlob) return;
            const tx = db.transaction(["songs"], "readwrite");
            tx.objectStore("songs").add({ id: Date.now(), name: currentFileName, data: currentFileBlob });
            tx.oncomplete = () => { refreshLibrary(); saveBtn.style.color = "#aaa"; };
        }

        function refreshLibrary() {
            const store = db.transaction("songs").objectStore("songs");
            store.getAll().onsuccess = e => {
                librarySelect.innerHTML = '<option value="">üìÇ Saved Library...</option>';
                e.target.result.forEach(s => {
                    const opt = document.createElement('option');
                    opt.value = s.id; opt.text = s.name;
                    librarySelect.appendChild(opt);
                });
            };
        }

        function loadFromLibrary() {
            const id = parseInt(librarySelect.value);
            if(!id) return;
            db.transaction("songs").objectStore("songs").get(id).onsuccess = e => {
                if(e.target.result) loadBlob(e.target.result.data, e.target.result.name);
            };
        }

        function deleteSong() {
            const id = parseInt(librarySelect.value);
            if(!id || !confirm("Delete?")) return;
            const tx = db.transaction(["songs"], "readwrite");
            tx.objectStore("songs").delete(id);
            tx.oncomplete = () => { refreshLibrary(); librarySelect.value = ""; };
        }

        document.getElementById('audioFile').addEventListener('change', e => {
            const file = e.target.files[0];
            if(file) { loadBlob(file, file.name); saveBtn.style.color = "#bb86fc"; }
        });

        function loadBlob(blob, name) {
            currentFileBlob = blob;
            currentFileName = name;
            document.getElementById('songTitle').textContent = name;
            audioPlayer.src = URL.createObjectURL(blob);
            audioPlayer.load();
            updateUI(false);
        }

        function forcePlay() {
            if(audioContext.state === 'suspended') audioContext.resume();
            if(!audioPlayer.src) return alert("Select a file");
            audioPlayer.paused ? audioPlayer.play() : audioPlayer.pause();
        }

        function updateUI(playing) {
            masterPlayBtn.innerHTML = playing ? "‚è∏" : "‚ñ∂";
            playing ? masterPlayBtn.classList.add('playing') : masterPlayBtn.classList.remove('playing');
            playing ? statusLight.classList.add('green') : statusLight.classList.remove('green');
        }

        audioPlayer.onplay = () => updateUI(true);
        audioPlayer.onpause = () => updateUI(false);
        audioPlayer.onended = () => updateUI(false);

        eqIds.forEach((id, i) => {
            document.getElementById(id).oninput = function() {
                if(filters[i]) filters[i].gain.value = this.value;
                saveEqSettings();
            };
        });

        document.getElementById('aiSearch').onkeypress = e => { if(e.key === 'Enter') aiSelectSong(); };
    </script>
</body>
</html>